# Climate template from github, add to HACS as custom integration
# https://github.com/jcwillox/hass-template-climate
climate:
  - platform: climate_template
    name: "Therma V heating/cooling"
    temp_step: 1
    max_temp_template: >
      {% if is_state('sensor.therma_v_operation_mode', '3') %}  {# auto mode #}
        {{ 5 }}
      {% elif states('sensor.therma_v_control_mode') < '2' %}   {# water temp. control, inlet or outlet #}
        {{ 40 }}
      {% else %}                                                {# probably room temp. control#}
        {{ 25 }}
      {% endif %}
    min_temp_template: >
      {% if is_state('sensor.therma_v_operation_mode', '3') %}  {# auto mode #}
        {{ -5 }}
      {% elif states('sensor.therma_v_control_mode') < '2' %}   {# water temp. control, inlet or outlet #}
        {{ 25 }}
      {% else %}                                                {# probably room temp. control #}
        {{ 16 }}
      {% endif %}
    current_temperature_template: > 
      {% if is_state('sensor.therma_v_control_mode', '0') %}    {# outlet water temperature control #}
        {{ states('sensor.therma_v_outlet_temperature') }}
      {% elif is_state('sensor.therma_v_control_mode', '1') %}  {# inlet water temperature control #}
        {{ states('sensor.therma_v_inlet_temperature') }}
      {% else %}                                                {# probably a form of room temperature control #}
        {{ states('sensor.therma_v_room_temperature') }}
      {% endif %}
    target_temperature_template: >
      {% if is_state('sensor.therma_v_operation_mode', '3') %} {# auto mode thus delta register #}
        {{ states('sensor.therma_v_auto_mode_target_temperature_delta_circuit_1') }}
      {% else %} {# other modes in regular register #}
        {{ states('sensor.therma_v_target_temperature_circuit_1') }}
      {% endif %}
    set_temperature: # variables temperature, target_temp_high, target_temp_low and hvac_mode 
      - choose:     
        - conditions:
            - "{{ is_state('sensor.therma_v_operation_mode', '3') }}" # auto mode 
          sequence:
            - action: modbus.write_register
              data_template:
                address: 4
                slave: 1
                hub: modbus_gateway_therma_v
                value: >
                  {% if temperature | int(0) < 0 %}
                    {{ temperature | int + 65536 }}
                  {% else %}
                    {{ temperature | int }}
                  {% endif %}
        default: # not auto mode   
          - action: modbus.write_register
            data_template:
              address: 2
              slave: 1
              hub: modbus_gateway_therma_v
              value: "{{ ((temperature | float(0)) * 10) | int }}"
    modes: ["off","cool","heat","auto"]
    hvac_mode_template: >
      {% if is_state('switch.therma_v_heating_cooling_on_off', 'off') %}
        {{'off'}}
      {% elif is_state('sensor.therma_v_operation_mode', '0') %}
        {{'cool'}}
      {% elif is_state('sensor.therma_v_operation_mode', '4') %}
        {{'heat'}}
      {% elif is_state('sensor.therma_v_operation_mode', '3') %}
        {{'auto'}}
      {% endif %}
    set_hvac_mode: # variable hvac_mode
      - choose:     
        - conditions:
            - "{{ hvac_mode == 'off'}}"
          sequence:
            - action: switch.turn_off # Turn off unit
              target:
                entity_id: switch.therma_v_heating_cooling_on_off
        - conditions:
            - "{{ hvac_mode == 'cool'}}"
          sequence:
            - action: switch.turn_on # Turn on unit
              target:
                entity_id: switch.therma_v_heating_cooling_on_off
            - action: modbus.write_register
              data_template:
                address: 0
                slave: 1
                hub: modbus_gateway_therma_v
                value: 0
        - conditions:
            - "{{ hvac_mode == 'heat'}}"
          sequence:
            - action: switch.turn_on # Turn on unit
              target:
                entity_id: switch.therma_v_heating_cooling_on_off
            - action: modbus.write_register
              data_template:
                address: 0
                slave: 1
                hub: modbus_gateway_therma_v
                value: 4
        - conditions:
            - "{{ hvac_mode == 'auto'}}"
          sequence:
            - action: switch.turn_on # Turn on unit
              target:
                entity_id: switch.therma_v_heating_cooling_on_off
            - action: modbus.write_register
              data_template:
                address: 0
                slave: 1
                hub: modbus_gateway_therma_v
                value: 3
        default:
          - action: switch.turn_on # Turn on unit
            target:
              entity_id: switch.therma_v_heating_cooling_on_off


  - platform: climate_template
    name: "Therma V DHW"
    max_temp: 70
    min_temp: 40    
    temp_step: 1
    current_temperature_template: "{{ states('sensor.therma_v_dhw_temperature') }}"
    target_temperature_template: "{{ states('sensor.therma_v_dhw_target_temperature') }}" 
    set_temperature:
      - action: modbus.write_register
        data_template:
          address: 8
          slave: 1
          hub: modbus_gateway_therma_v
          value: "{{ (( temperature | float(0) )*10) | int }}"      
    modes: ["off","auto"]
    hvac_mode_template: >
      {% if is_state('switch.therma_v_dhw_on_off','off') %}
        {{"off"}}
      {% else %}  
        {{"auto"}}
      {% endif %}
    set_hvac_mode: # variable hvac_mode
      - choose:
        - conditions:
            - "{{ hvac_mode == 'off'}}"
          sequence:
            - action: switch.turn_off # Turn off unit
              target:
                entity_id: switch.therma_v_dhw_on_off
        - conditions:
            - "{{ hvac_mode == 'auto'}}"
          sequence:
            - action: switch.turn_on # Turn on unit
              target:
                entity_id: switch.therma_v_dhw_on_off



# # Same as on the RMC. 
# # In case of Air+Water first set water control mode (0 or 1) then set to Air+Water (2)
# #       - "Water outlet temperature"  # 0
# #       - "Water inlet temperature"   # 1
# #       - "Room temperature"          # 2
# input_select:
#   therma_v_temperature_control_mode:
#     name: "Therma V temperature control mode"
#     options:
#       - "Water"
#       - "Air + Water"
#   therma_v_water_control_mode:
#     name: "Therma V water control mode"
#     options:
#       - "Water Inlet"
#       - "Water Outlet"
#       - "Unknown"

# automation:  ## STILL NEEDS A LOT OF WORKING ON
#   - id: "therma_v_control_mode_update_auto"
#     alias: "Therma V control mode update auto"
#     description: "Updates the control mode based on input numbers and modbus"
#     mode: single
#     triggers:
#       - trigger: state
#         entity_id: input_select.therma_v_temperature_control_mode
#         id: ctrl_select_trig1
#       - trigger: state
#         entity_id: input_select.therma_v_water_control_mode
#         id: ctrl_select_trig2
#       # - trigger: state
#       #   entity_id: sensor.therma_v_control_mode
#       #   id: ctrl_modbus_trig
#       # # when inconsistent for x run default
#       # - trigger: template
#       #   value_template: "{{ ( (states('sensor.therma_v_control_mode') | round(0)) - (states('sensor.therma_v_target_temperature_circuit_1') | round(0)) ) | abs > 0 }}"
#       #   for: "00:02:00"
#       #   id: auto_catch_trig
#     condition: []
#     actions:
#       - choose:
#           - conditions:
#           # Don't use this trigger for room control since inlet / outlet will be unknown, now the last state is kept
#                 - condition: trigger
#                   id: ctrl_modbus_trig1 
#             sequence:
#               - action: input_select.select_option
#                 target:
#                   entity_id: input_select.therma_v_water_control_mode
#                 data:
#                   option: >
#                     {% set idx = trigger.to_state.state | int(0) %}
#                     {% if idx < 2 %}
#                       {{ state_attr("input_therma_v_water_control_mode", "options")[ idx ] }}
#                     {% endif %}
#               - action: input_select.select_option
#                 target:
#                   entity_id: input_select.therma_v_temperature_control_mode
#                 data:
#                   option: >
#                     {% set idx = trigger.to_state.state | int(0) %}
#                     {% if idx < 2 %}
#                       {{ state_attr("input_select.therma_v_temperature_control_mode", "options")[ 0 ] }}
#                     {% else %} {# some form of room control so inlet outlet unknown #}
#                       {{ state_attr("input_select.therma_v_temperature_control_mode", "options")[ 1 ] }}
#                     {% endif %}
#         default:
#           - variables:
#               temp_ctrl_mode: "{{state_attr('input_select.therma_v_temperature_control_mode','options').index(input_select.therma_v_temperature_control_mode) | int(0)}}"
#               watr_ctrl_mode: "{{state_attr('input_select.therma_v_water_control_mode','options').index(input_select.therma_v_water_control_mode) | int(0)}}" 
#           - action: modbus.write_register
#             data_template:
#               address: 1
#               slave: 1
#               hub: modbus_gateway_therma_v
#               value: "{{ watr_ctrl_mode }}"
#           - choose:


#         # - action: modbus.write_register
#         #   data_template:
#         #     address: 1
#         #     slave: 1
#         #     hub: modbus_gateway_therma_v
#         #     value: >
#         #       {% set idx = state_attr('input_select.therma_v_control_mode','options').index(states('input_select.therma_v_control_mode')) %}
#         #       {% if idx < 3 %}
#         #         {{ idx }}
#         #       {% else %}
#         #         {{ room }}
#         #       {% endif %}
#         #     # - delay: '00:00:01' # prevent retriggering on write event